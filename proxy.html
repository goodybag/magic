<!DOCTYPE HTML>
<html>
  <head>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://www.goodybag.com/js/porthole.js"></script>
    <script type="text/javascript" src="http://www.goodybag.com/js/easyXDM.min.js"></script>
    <script type="text/javascript">
      window.onload = function(){

        var socket = new easyXDM.Socket({
          remote: "http://www.goodybag.com/", // the path to the provider
          onMessage:function(message, origin) {
            alert("INSIDE");
          }
        });

        socket.postMessage("hello from the inside");

        // Create a proxy window to send to and receive messages from the parent
        var windowProxy = new Porthole.WindowProxy('http://www.goodybag.com/');

        window.parent.postMessage("just testing", '*');

        // Register an event handler to receive messages;
        windowProxy.addEventListener(function(event){
          console.log('PROXY RECEIVED DATA', JSON.stringify(event));
          console.log(event.data.rid);
          var rid = event.data.rid;

          window.parent.postMessage("just testing", '*');

          return windowProxy.post('just testing');

          event.data.success = function(results){
            if (typeof results == 'string') results = JSON.parse(results);
            results = results || {};
            results.rid = rid;
            windowProxy.post(results);
          };

          event.data.error = function(xhr, status, error){
            error = xhr.responseText ? JSON.parse(error.responseText) : error;
            windowProxy.post({ xhr: xhr, status: status, error: error, rid: rid });
          };

          // No need for CORS
          delete event.data.withCredentials;
          delete event.data.xhrFields;

          // Send
          $.ajax(event.data);
        });
      };
    </script>
  </head>
  <body></body>
</html>